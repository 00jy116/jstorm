<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : 灰度发布</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/QuickStart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/QuickStart_cn/Deploy/index.html">安装部署</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/index.html">升级</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/NewWindow.html">JStorm最新窗口机制</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/index.html">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/index.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/SupervisorWorker.html">生成worker列表算法</a></li>
                  
                  <li class="active"><a href="/Maintenance_cn/GrayUpgrade.html">灰度发布</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>灰度发布</h1>
	<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">背景</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">功能介绍</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">限制</a></li>
  <li><a href="#section-3" id="markdown-toc-section-3">使用</a>    <ul>
      <li><a href="#section-4" id="markdown-toc-section-4">初始化灰度发布升级请求。</a></li>
      <li><a href="#section-7" id="markdown-toc-section-7">继续发布</a></li>
      <li><a href="#section-8" id="markdown-toc-section-8">结束发布</a></li>
      <li><a href="#section-9" id="markdown-toc-section-9">发布回滚</a></li>
    </ul>
  </li>
  <li><a href="#section-10" id="markdown-toc-section-10">内部流程</a></li>
  <li><a href="#todo" id="markdown-toc-todo">TODO</a></li>
</ul>

<h2 id="section">背景</h2>

<p>应用代码修改的时候，以往是只能kill掉重新提交，这会带来比较大的数据抖动。另一方面，有可能用户只修改了一小部分代码，比如某个component的代码，
这种情况下，可能只想重启这个component。</p>

<p>在这样的背景下，我们开发了灰度发布功能。</p>

<h2 id="section-1">功能介绍</h2>

<p>灰度发布支持以下功能：</p>

<ol>
  <li>
    <p>指定worker列表重启</p>
  </li>
  <li>
    <p>指定component重启</p>
  </li>
  <li>
    <p>指定component，并指定worker数，重启这个component下的指定数量的worker</p>
  </li>
  <li>
    <p>指定worker数，由框架随机选择worker进行重启</p>
  </li>
  <li>
    <p>支持回滚</p>
  </li>
</ol>

<h2 id="section-2">限制</h2>

<p>使用此功能前请先了解相关限制：</p>

<ol>
  <li>
    <p>需要将TM设置为单独的worker，即topology.master.single.worker必须设置为true。</p>
  </li>
  <li>
    <p>修改代码前后，消息流不能有大的变化。即，不能引入一种新的grouping或者新的fields、stream等，必须保证worker重启后，
各个component能够正常接收解析消息流。如果有大的消息流的变化，建议使用应用热升级功能，
见：http://gitlab.alibaba-inc.com/aloha/jstorm-guide/wikis/How-to-deploy</p>
  </li>
</ol>

<h2 id="section-3">使用</h2>

<h3 id="section-4">初始化灰度发布升级请求。</h3>

<p>因为要得到新的storm code，这个复用了提交拓扑的命令。</p>

<pre><code>jstorm jar /home/weiyue.wy/sequence-split-merge.jar com.alipay.dw.jstorm.example.sequence.SequenceTopology /home/weiyue.wy/t.yaml -c topology.upgrade=true -c user.defined.log4j.conf=
</code></pre>

<p>初始化之后，拓扑状态会变成UPGRADING。</p>

<h4 id="section-5">参数说明</h4>

<p>topology.upgrade: 开始灰度发布，初始化的时候必须为true。</p>

<p>topology.master.single.worker: 指定TM使用单独的worker，必须为true。</p>

<p>topology.upgrade.worker.num: 指定这一次升级的worker数，默认为1。如果只想初始化，并不想让它自动随机挑选worker，可以设置为0</p>

<p>topology.upgrade.ttl: 灰度发布超时时间，单位为ms。默认为1天（86400 * 1000）。超过1天灰度发布会强行自动结束，拓扑状态从UPGRADING重新变成ACTIVE。</p>

<p>topology.upgrade.workers: 指定worker列表进行灰度发布，格式为host:port,host:port。</p>

<p>topology.upgrade.component: 指定component id进行灰度发布，每次只能指定一个component。</p>

<h4 id="section-6">参数优先级说明</h4>

<p>topology.upgrade.workers，topology.upgrade.component，topology.upgrade.worker.num这三个参数，都用于挑选worker进行发布。</p>

<p>具体算法优先级如下：</p>

<ol>
  <li>
    <p>如果topology.upgrade.workers不为空，则忽略其他参数，挑选指定的worker进行发布，需要注意的是，这些worker发布完之后，这个参数就自动置空了。</p>
  </li>
  <li>
    <p>否则查看topology.upgrade.component是否为空，如果不为空，则还需要查看topology.upgrade.worker.num是否为0，
如果不为0，则挑选指定component下topology.upgrade.worker.num进行发布。否则对这个component下所有worker进行发布。</p>
  </li>
  <li>
    <p>如果上面两个都为空，随机挑选topology.upgrade.worker.num个worker进行发布。</p>
  </li>
</ol>

<h3 id="section-7">继续发布</h3>

<p>进行了初始化发布之后，有可能需要继续进行灰度发布（比如初始化的时候，只指定了一个worker）。请使用gray_upgrade命令进行继续发布。</p>

<pre><code>jstorm gray_upgrade &lt;topology_name&gt; -w &lt;workers&gt; -n &lt;worker_num&gt; -p &lt;component&gt;
</code></pre>

<p>jstorm会记住当前正在进行的发布，所以继续发布不需要重新上传jar。</p>

<h3 id="section-8">结束发布</h3>

<p>如果所有worker都已经完成了发布，jstorm会自动完成灰度发布，并将拓扑状态置为ACTIVE。</p>

<p>如果想提前完成，请使用complete_upgrade命令。</p>

<pre><code>jstorm complete_upgrade &lt;topology_name&gt;
</code></pre>

<h3 id="section-9">发布回滚</h3>

<p>如果想要回滚，请使用rollback命令。</p>

<pre><code>jstorm rollback &lt;topology_name&gt;
</code></pre>

<p><strong>需要注意的是，rollback命令不能挑选worker。它会挑选所有已经发布过的worker，用旧的代码和jar进行回滚。且是不可逆的，
即rollback之后，就不能继续灰度发布，需要重新初始化提交</strong></p>

<h2 id="section-10">内部流程</h2>

<ol>
  <li>
    <p>client以提交拓扑的形式提交灰度发布命令（因为需要重新生成storm code，因此复用submitTopology接口），
指定topology.upgrade=true，并上传新的jar包。</p>
  </li>
  <li>
    <p>nimbus收到请求后，设置灰度发布配置GrayUpgradeConfig，写入到zk中/gray_upgrade/topo-id/节点下。
将config.continueUpgrading设置为true</p>
  </li>
  <li>
    <p>TM有一个定时线程GrayUpgradeHandler，读取该节点的配置，检测到灰度发布配置且continueUpgrading=true时，
将分配指定workerNum的worker数，添加到zk的/gray_upgrade/topo-id/upgrading_workers节点下。
并将continueUpgrading设置为false（防止自动进行后续的灰度发布）。注意使用单独的upgrading_workers和upgraded_workers的设计，
主要是避免同步问题。如果将这些信息写在upgrade config类中，那可能会涉及到多个supervisor同时更新workers的情况，这样是会有同步问题的。
而使用单独的节点，我们只需要在这个节点下添加/删除子节点，不会有同步问题。</p>
  </li>
  <li>
    <p>SyncSupervisorEvent会定时检查每个拓扑的这个节点，一旦有数据，就和自身的IP和port list进行对比，如果有属于该supervisor的灰度发布，
就下载最新的storm code和storm jar，然后重启worker。然后将worker添加到zk的upgraded_workers节点下。</p>
  </li>
  <li>
    <p>GrayUpgradeHandler检测ZK，如果upgraded_workers的worker数&gt;=当前总worker数-1（减去TM本身），则认为此次灰度发布已经完成，
删除zk上的GrayUpgradeConfig、upgrading_workers、upgraded_workers。</p>
  </li>
  <li>
    <p>如果只想升级部分worker或特定component，可以用complete_upgrade强制完成升级。</p>
  </li>
</ol>

<h2 id="todo">TODO</h2>

<ol>
  <li>
    <p>worker进行升级时是否需要将上游spout先做deactivate，是否需要做graceful shutdown？</p>
  </li>
  <li>
    <p>supervisor的定时线程周期为10s一次，在大集群中，如果灰度发布的拓扑比较多，会不会因为处理时间比较长而打乱这个定时周期？</p>
  </li>
</ol>

  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
 
      发现错误？想参与编辑？
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/Maintenance_cn/GrayUpgrade.md" target="_blank">
        在 Github 上编辑此页！
      </a>
  </div>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
